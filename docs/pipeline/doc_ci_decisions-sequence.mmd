
graph TD
    Start[Workflow Trigger] --> TriggerType{Trigger Type?}

%% Workflow Dispatch Branch
    TriggerType -->|workflow_dispatch| Action{Action Type?}
    Action -->|accept-references| AcceptRef[Accept References Job]
    Action -->|test| MainFlow

%% PR and Push Branch
    TriggerType -->|PR/Push| MainFlow[Main Flow]

%% Main Parallel Jobs - Now with failure handling
    MainFlow --> Lint[Lint & Typecheck]
    MainFlow --> Unit[Unit Tests]
    MainFlow --> Build[Build Test]
    MainFlow --> Visual[Visual Tests]
    MainFlow --> E2E[E2E Tests]

%% Test Results
    Unit --> UnitResult{Unit Tests Pass?}
    Visual --> VisualResult{Visual Tests Pass?}
    E2E --> E2EResult{E2E Tests Pass?}

%% Critical Failure Path
    UnitResult -->|No| PipelineFail[Pipeline Fails]
    VisualResult -->|No| PipelineFail
    E2EResult -->|No| PipelineFail

%% Non-Critical Paths
    Lint --> LintResult{Lint Passes?}
    LintResult -->|No| ContinuePipeline[Continue Pipeline]
    LintResult -->|Yes| ContinuePipeline
    
    Build --> BuildResult{Build Passes?}
    BuildResult -->|No| ContinuePipeline
    BuildResult -->|Yes| ContinuePipeline

%% Success Path
    UnitResult & VisualResult & E2EResult -->|All Pass| DeployType{Deploy Type?}

%% Deployment Flows
    DeployType -->|PR| Preview[Deploy Preview]
    DeployType -->|Main Branch| Prod[Deploy Production]

%% Accept References Flow
    AcceptRef --> UpdateRef[Update Reference Images]
    UpdateRef --> Commit[Commit Changes]
    Commit --> Push[Push to Main]

%% Styling
    classDef trigger fill:#f9f,stroke:#333,stroke-width:2px
    classDef condition fill:#fcf,stroke:#333,stroke-width:2px
    classDef job fill:#cfc,stroke:#333,stroke-width:2px
    classDef artifact fill:#cff,stroke:#333,stroke-width:2px
    classDef failure fill:#fcc,stroke:#333,stroke-width:2px

    class Start trigger
    class TriggerType,Action,UnitResult,VisualResult,E2EResult,DeployType,LintResult,BuildResult condition
    class Lint,Unit,Build,Visual,E2E,Preview,Prod,AcceptRef job
    class PipelineFail failure
