sequenceDiagram
    participant User
    participant EditView
    participant KeyboardHandler
    participant MessageEditorContext
    participant Store
    participant Modal
    participant APIService

    Note over EditView: Component renders based on isComposer

    alt Button Interactions
        alt 1. Composer Mode
            rect rgb(240,230,255)
                User->>EditView: Click "Save & Submit"
                EditView->>MessageEditorContext: Call handleSaveAndSubmit()
                MessageEditorContext->>Store: Add message to chat
                
                rect rgb(230,245,255)
                    Note over Store: AI Response Phase
                    Store->>APIService: Submit conversation context
                    APIService-->>Store: Stream AI response
                    
                    loop For each token
                        Store->>Store: Update AI message content
                        Store-->>EditView: Render updated content
                    end
                end
                
                MessageEditorContext->>Store: Clear input
                MessageEditorContext->>EditView: Reset textarea height
            end

            rect rgb(230,255,255)
                User->>EditView: Click "Save"
                EditView->>MessageEditorContext: Call handleSave()
                MessageEditorContext->>Store: Store draft content
            end
        else 2. Non-Composer Mode (Edit)
            rect rgb(255,255,230)
                User->>EditView: Click "Save"
                EditView->>MessageEditorContext: Call handleSave()
                MessageEditorContext->>Store: Update message content
                MessageEditorContext->>EditView: Exit edit mode
            end

            rect rgb(255,230,230)
                User->>EditView: Click "Save & Submit"
                EditView->>Modal: Open confirmation modal
                User->>Modal: Confirm
                Modal->>MessageEditorContext: Call handleSaveAndSubmit()
                MessageEditorContext->>Store: Update message content
                MessageEditorContext->>Store: Remove subsequent messages
                MessageEditorContext->>Store: Trigger regeneration
                
                rect rgb(230,245,255)
                    Note over Store: AI Response Phase
                    Store->>APIService: Submit updated conversation context
                    APIService-->>Store: Stream AI response
                    
                    loop For each token
                        Store->>Store: Update AI message content
                        Store-->>EditView: Render updated content
                    end
                end
                
                MessageEditorContext->>EditView: Exit edit mode
            end

            rect rgb(230,230,255)
                User->>EditView: Click "Cancel"
                EditView->>MessageEditorContext: Call setIsEdit(false)
                MessageEditorContext->>EditView: Exit edit mode without saving
            end
        end
    else Keyboard Shortcuts
        alt 3. Composer Mode with "Enter to Submit" enabled
            rect rgb(240,255,240)
                User->>KeyboardHandler: Press Enter
                KeyboardHandler->>MessageEditorContext: Call handleSaveAndSubmit()
                MessageEditorContext->>Store: Add message to chat
                
                rect rgb(230,245,255)
                    Note over Store: AI Response Phase
                    Store->>APIService: Submit conversation context
                    APIService-->>Store: Stream AI response
                    
                    loop For each token
                        Store->>Store: Update AI message content
                        Store-->>EditView: Render updated content
                    end
                end
                
                MessageEditorContext->>Store: Clear input
                MessageEditorContext->>EditView: Reset textarea height
            end

            rect rgb(255,240,255)
                User->>KeyboardHandler: Press Shift+Enter
                KeyboardHandler->>EditView: Insert newline
            end
        else 4. Composer Mode with "Enter to Submit" disabled
            rect rgb(230,255,230)
                User->>KeyboardHandler: Press Enter
                KeyboardHandler->>EditView: Insert newline
            end

            rect rgb(255,230,255)
                User->>KeyboardHandler: Press Ctrl+Enter or Shift+Enter
                KeyboardHandler->>MessageEditorContext: Call handleSaveAndSubmit()
                MessageEditorContext->>Store: Add message to chat
                
                rect rgb(230,245,255)
                    Note over Store: AI Response Phase
                    Store->>APIService: Submit conversation context
                    APIService-->>Store: Stream AI response
                    
                    loop For each token
                        Store->>Store: Update AI message content
                        Store-->>EditView: Render updated content
                    end
                end
                
                MessageEditorContext->>Store: Clear input
                MessageEditorContext->>EditView: Reset textarea height
            end
        else 5. Non-Composer Mode (Edit)
            rect rgb(240,240,255)
                User->>KeyboardHandler: Press Escape
                KeyboardHandler->>MessageEditorContext: Call setIsEdit(false)
                MessageEditorContext->>EditView: Exit edit mode without saving
            end

            rect rgb(255,240,240)
                User->>KeyboardHandler: Press Ctrl+Shift+Enter
                KeyboardHandler->>MessageEditorContext: Call handleSaveAndSubmit()
                MessageEditorContext->>Store: Update message content
                MessageEditorContext->>Store: Remove subsequent messages
                MessageEditorContext->>Store: Trigger regeneration
                
                rect rgb(230,245,255)
                    Note over Store: AI Response Phase
                    Store->>APIService: Submit updated conversation context
                    APIService-->>Store: Stream AI response
                    
                    loop For each token
                        Store->>Store: Update AI message content
                        Store-->>EditView: Render updated content
                    end
                end
                
                MessageEditorContext->>EditView: Exit edit mode
            end

            rect rgb(240,255,255)
                User->>KeyboardHandler: Press Ctrl+Enter or Shift+Enter
                KeyboardHandler->>MessageEditorContext: Call handleSave()
                MessageEditorContext->>Store: Update message content
                MessageEditorContext->>EditView: Exit edit mode
            end
        end
    end

    Note over EditView: Buttons disabled during generation

    alt 6. Regeneration Flow
        User->>EditView: Click "Regenerate" button
        EditView->>Store: regenerateMessage()
        
        rect rgb(240,240,240)
            Note over Store: State Update Phase
            Store->>Store: Clone current chat
            Store->>Store: Find last message
            Store->>Store: Mark last message as outdated
            Store->>Store: Add new placeholder message
            Store->>Store: Update store state
        end
        
        rect rgb(230,240,255)
            Note over EditView: UI Update Phase
            Store-->>EditView: State changes
            EditView->>EditView: Render outdated message (dimmed)
            EditView->>EditView: Show loading state for new message
        end
        
        rect rgb(255,240,230)
            Note over Store: API Phase
            Store->>APIService: Submit conversation context
            APIService-->>Store: Stream new response
            
            loop For each token
                Store->>Store: Update new message content
                Store-->>EditView: Render updated content
            end
        end
        
        rect rgb(230,255,240)
            Note over EditView: Final State
            EditView->>EditView: Show both messages:
            Note over EditView: 1. Previous (dimmed, marked as outdated)
            Note over EditView: 2. New (normal, marked as current)
        end
    end
